removed del res in layer iteration, added code to write layer it data and some refactoring
